---
import Layout from "../../layouts/Layout.astro";
import { seoConfig } from "@/config/seo-config.ts";
import Button from "../../components/ui/Button.astro";
---

<Layout
  title={seoConfig.contact.title}
  description={seoConfig.contact.description}
  image={seoConfig.contact.image}
  robots={seoConfig.contact.robots}
>
  <div class="lg:pt-24 sm:pt-24 pt-24 px-6 py-10 sm:py-12 lg:px-8">
    <div class="mx-auto max-w-250 text-center">
      <h2 class="text-4xl font-semibold tracking-tight text-balance text-gray-900 sm:text-5xl">Contáctenos</h2>
      <p class="mt-5 text-lg leading-relaxed text-gray-600">
        Si tiene alguna pregunta sobre nuestros productos o servicios, o desea solicitar un presupuesto personalizado,
        no dude en contactar a nuestro equipo de ventas. Estaremos encantados de ayudarle.
      </p>
    </div>
    <form method="POST" id="form" class="mt-10 needs-validation max-w-2xl mx-auto grid gap-6" novalidate>
      <input type="hidden" name="access_key" value={import.meta.env.CONTACT_ACCESS_KEY} />
      <input type="hidden" name="from_name" value="INODE64" />
      <input type="hidden" name="subject" value="Nueva consulta desde la web" />
      <input type="hidden" name="botcheck" value="" />

      <div class="flex flex-col md:flex-row md:space-x-4 mb-2 space-y-4 md:space-y-0">
        <div class="w-full md:w-1/2">
          <label for="first_name" class="block mb-2 text-sm text-gray-600 dark:text-gray-400">Nombre</label>
          <input
            type="text"
            name="nombre"
            id="first_name"
            placeholder="Nombre"
            required
            class="w-full px-3 py-2 placeholder-gray-300 border-2 border-gray-200 rounded-md focus:outline-none focus:ring focus:ring-indigo-100 focus:border-indigo-300 bg-white dark:bg-gray-800 transition-colors duration-200"
          />
          <div class="empty-feedback invalid-feedback text-red-400 text-sm mt-1">Por favor, indique su nombre.</div>
        </div>
        <div class="w-full md:w-1/2">
          <label for="surname" class="block mb-2 text-sm text-gray-600 dark:text-gray-400">Apellidos</label>
          <input
            type="text"
            name="apellidos"
            id="surname"
            placeholder="Apellidos"
            required
            class="w-full px-3 py-2 placeholder-gray-300 border-2 border-gray-200 rounded-md focus:outline-none focus:ring focus:ring-indigo-100 focus:border-indigo-300 bg-white dark:bg-gray-800 transition-colors duration-200"
          />
          <div class="empty-feedback invalid-feedback text-red-400 text-sm mt-1">Por favor, indique sus apellidos.</div>
        </div>
      </div>

      <div class="flex flex-col md:flex-row md:space-x-4 mb-6 space-y-4 md:space-y-0">
        <div class="w-full md:w-1/2">
          <label for="email" class="block mb-2 text-sm text-gray-600 dark:text-gray-400">Correo electrónico</label>
          <input
            type="email"
            name="email"
            id="email"
            placeholder="tu@empresa.com"
            required
            class="w-full px-3 py-2 placeholder-gray-300 border-2 border-gray-200 rounded-md focus:outline-none focus:ring focus:ring-indigo-100 focus:border-indigo-300 bg-white dark:bg-gray-800 transition-colors duration-200"
          />
          <div class="empty-feedback text-red-400 text-sm mt-1">Por favor, indique su correo electrónico.</div>
          <div class="invalid-feedback text-red-400 text-sm mt-1">Por favor, indique un correo electrónico válido.</div>
        </div>

        <div class="w-full md:w-1/2">
          <label for="phone" class="block text-sm mb-2 text-gray-600 dark:text-gray-400">Teléfono</label>
          <input
            type="text"
            name="phone"
            id="phone"
            placeholder="123 456 789"
            required
            class="w-full px-3 py-2 placeholder-gray-300 border-2 border-gray-200 rounded-md focus:outline-none focus:ring focus:ring-indigo-100 focus:border-indigo-300 bg-white dark:bg-gray-800 transition-colors duration-200"
          />
          <div class="empty-feedback invalid-feedback text-red-400 text-sm mt-1">
            Por favor, indique su número de teléfono.
          </div>
        </div>
      </div>
      <div class="mb-6">
        <label for="message" class="block mb-2 text-sm text-gray-600 dark:text-gray-400">Mensaje</label>
        <textarea
          rows="5"
          name="mensaje"
          id="message"
          placeholder="Escriba su mensaje"
          class="w-full px-3 py-2 placeholder-gray-300 border-2 border-gray-200 rounded-md focus:outline-none focus:ring focus:ring-indigo-100 focus:border-indigo-300 bg-white dark:bg-gray-800 transition-colors duration-200"
          required
        >
        </textarea>
        <div class="empty-feedback invalid-feedback text-red-400 text-sm mt-1">Por favor, escriba su mensaje.</div>
        <div class="mt-2 flex gap-x-4 sm:col-span-2">
          <div class="flex h-6 items-center">
            <label class="relative inline-block w-10 h-6 cursor-pointer" id="privacy-switch-label">
              <span class="sr-only">Aceptar la política de privacidad</span>
              <input
                type="checkbox"
                id="privacy-policy-checkbox"
                class="sr-only peer"
                aria-describedby="privacy-description privacy-error"
                required
              />
              <span
                class="absolute left-0 top-0 h-6 w-10 rounded-full bg-gray-200 transition-colors duration-200 peer-checked:bg-red-800"
              >
              </span>
              <span
                class="absolute left-0 top-0 h-6 w-6 rounded-full bg-white ring-1 shadow-xs ring-gray-900/5 transform transition-transform duration-200 translate-x-0 peer-checked:translate-x-4"
              >
              </span>
            </label>
          </div>
          <p class="text-sm/6 text-gray-600" id="privacy-description">
            Al seleccionar esto, acepta nuestra
            <a href="/privacy" class="font-semibold text-red-800">política&nbsp;de&nbsp;privacidad</a>.
          </p>
        </div>
        <div id="privacy-error" class="text-red-400 text-sm mt-1 hidden" role="alert">
          Debe aceptar la política de privacidad
        </div>
      </div>
      <div class="h-captcha" data-captcha="true"></div>
      <div class="mb-6">
        <Button type="submit" text="Enviar consulta" withFull={true} />
      </div>
      <p class="text-base text-center text-gray-400 mt-4 min-h-[1.5rem]" id="result" role="status" aria-live="polite" aria-atomic="true"></p>
    </form>
  </div>
</Layout>

<style>
  .invalid-feedback,
  .empty-feedback {
    display: none;
  }

  .was-validated :placeholder-shown:invalid ~ .empty-feedback {
    display: block;
  }

  .was-validated :not(:placeholder-shown):invalid ~ .invalid-feedback {
    display: block;
  }

  .is-invalid,
  .was-validated :invalid {
    border-color: #dc3545;
  }
</style>

<script src="https://web3forms.com/client/script.js" async defer></script>

<script type="module">
  window.addEventListener("load", () => {
    const form = document.getElementById("form");
    const result = document.getElementById("result");
    const privacyCheckbox = document.getElementById("privacy-policy-checkbox");
    const privacyError = document.getElementById("privacy-error");
    if (!form || !result) return;

    const markCaptchaResponse = () => {
      const hcaptchaResponse = form.querySelector('textarea[name="h-captcha-response"]');
      if (!hcaptchaResponse) return false;
      hcaptchaResponse.setAttribute("aria-hidden", "true");
      hcaptchaResponse.setAttribute("tabindex", "-1");
      return true;
    };

    if (!markCaptchaResponse()) {
      const observer = new MutationObserver(() => {
        if (markCaptchaResponse()) observer.disconnect();
      });
      observer.observe(form, { childList: true, subtree: true });
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      e.stopPropagation();

      // Validación captcha
      const hCaptchaElem = form.querySelector('textarea[name="h-captcha-response"]');
      const hCaptcha = hCaptchaElem ? hCaptchaElem.value : "";
      if (!hCaptcha) {
        alert("❌ Por favor, complete la verificación captcha");
        return;
      }

      // Validación checkbox privacidad
      if (privacyCheckbox && !privacyCheckbox.checked) {
        alert("❌ Debes aceptar la política de privacidad antes de enviar el formulario.");
        privacyCheckbox.setAttribute("aria-invalid", "true");
        if (privacyError) privacyError.classList.remove("hidden");
        privacyCheckbox.focus();
        return;
      } else {
        if (privacyError) privacyError.classList.add("hidden");
        privacyCheckbox?.removeAttribute("aria-invalid");
      }

      // Validación HTML5
      if (!form.checkValidity()) {
        const firstInvalid = form.querySelector(":invalid");
        if (firstInvalid) firstInvalid.focus();
        form.classList.add("was-validated");
        return;
      }

      // Envío del formulario
      const formData = new FormData(form);
      const object = {};
      formData.forEach((value, key) => {
        object[key] = value.toString();
      });

      result.textContent = "Enviando...";
      result.className = "text-base text-center mt-4 min-h-[1.5rem] text-green-600 font-semibold animate-shake";
      result.style.display = "block";

      try {
        const response = await fetch("https://api.web3forms.com/submit", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Accept: "application/json",
          },
          body: JSON.stringify(object),
        });
        const data = await response.json();
        result.textContent = data.message;

        if (data.success) {
          window.location.href = "/contact/success";
        } else {
          result.className = "text-base text-center text-red-500 mt-4 min-h-[1.5rem]";
        }
      } catch {
        result.textContent = "Ha ocurrido un error.";
        result.className = "text-base text-center mt-4 min-h-[1.5rem] text-red-600 font-semibold animate-shake";
      } finally {
        form.reset();
        form.classList.remove("was-validated");
        setTimeout(() => {
          if (result) result.style.display = "none";
        }, 5000);
      }

      form.classList.add("was-validated");
    });
  });
</script>
